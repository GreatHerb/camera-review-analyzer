<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Camera Review Analyzer</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/modern-css-reset@1.4.0/dist/reset.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Apple SD Gothic Neo, "Noto Sans KR", Arial, sans-serif; background:#0f172a; color:#e2e8f0; }
    .wrap { max-width: 1100px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 26px; font-weight: 700; margin-bottom: 18px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }
    .card { background:#111827; border:1px solid #1f2937; border-radius: 16px; padding: 18px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    .card h2 { font-size:14px; color:#94a3b8; margin-bottom:8px; font-weight:600; }
    .stat { font-size: 28px; font-weight:800; color:#f1f5f9; }
    .muted { color:#94a3b8; font-size:12px; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #1f2937; vertical-align: top; }
    th { text-align:left; color:#93c5fd; font-weight:700; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #1f2937; }
    .pos { color:#22c55e; border-color:#14532d; background:#052e16; }
    .neu { color:#eab308; border-color:#713f12; background:#422006; }
    .neg { color:#f43f5e; border-color:#7f1d1d; background:#450a0a; }
    a.link { color:#93c5fd; text-decoration:none; }
    .kicker { color:#94a3b8; font-size:12px; margin-top:6px; }

    /* ê²€ìƒ‰ë°”: ë†’ì´/í­ ì•ˆì •í™” */
    .searchbar {
      display:flex;
      gap:8px;
      flex-wrap:nowrap;
      align-items:center;
      margin-bottom:4px;
    }
    .input {
      background:#0b1220;
      color:#e2e8f0;
      border:1px solid #334155;
      border-radius:10px;
      padding:8px 12px;
      font-size:14px;
      flex:1 1 auto;
      min-width:240px;
    }
    .select {
      background:#0b1220;
      color:#e2e8f0;
      border:1px solid #334155;
      border-radius:10px;
      padding:8px 12px;
      font-size:14px;
      flex:0 0 150px;
      max-width:150px;
      box-sizing:border-box;
      white-space:nowrap;
    }
    .action {
      background:#1f2937;
      border:1px solid #334155;
      color:#cbd5e1;
      padding:8px 14px;
      border-radius:10px;
      cursor:pointer;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .searchbar a.link {
      flex:0 0 auto;
      white-space:nowrap;
    }

    .pager { display:flex; align-items:center; gap:10px; margin-top:12px; }
    .pager .action[disabled] { opacity:.5; cursor:not-allowed; }
    .small { font-size:12px; color:#94a3b8; }

    .kw-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .kw-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; background:#020617; border:1px solid #1f2937; color:#e2e8f0; }
    .kw-chip span.kw-freq { font-size:11px; color:#94a3b8; }

    /* ë‚ ì§œ ì»¬ëŸ¼: í•œ ì¤„ ê³ ì • */
    .col-date {
      white-space:nowrap;
      width:110px;
    }

    /* ë­í‚¹ ì¹´ë“œ (ì˜¤ë¥¸ìª½ í”Œë¡œíŒ… ì‚¬ì´ë“œ íŒ¨ë„) */
    .rank-card h2 { margin-bottom:4px; }
    #rank-desc { font-size:11px; }
    #top-reco { font-size:11px; }
    #rank-tbl { font-size:13px; }
    #rank-tbl th, #rank-tbl td { padding:6px 8px; }
    #rank-tbl tbody tr { cursor:pointer; }
    #rank-tbl tbody tr:hover { background:#020617; }

    .rank-float {
      position: fixed;
      top: 160px;
      right: 24px;
      width: 260px;
      z-index: 40;
    }

    /* í™”ë©´ì´ ì¡°ê¸ˆë§Œ ì¤„ì–´ë“¤ì–´ë„ ë³¸ë¬¸ ì¹¨ë²”í•˜ì§€ ì•Šë„ë¡ ê¸°ì¤€ì„ 1400pxë¡œ ìƒí–¥ */
    @media (max-width: 1400px) {
      .rank-float {
        position: static;
        width: auto;
        max-width: 1100px;
        margin: 0 auto 24px;
        padding: 0 16px;
      }
      .rank-float .card { margin-top: 16px; }
      .searchbar { flex-wrap:wrap; } /* ëª¨ë°”ì¼/ì¢ì€ í™”ë©´ì—ì„œëŠ” ì¤„ë°”ê¿ˆ í—ˆìš© */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Camera Review Analyzer</h1>

    <!-- ìƒë‹¨ ì¹´ë“œ: í†µê³„ (ì„ íƒëœ ì¹´ë©”ë¼ ê¸°ì¤€) -->
    <div class="grid" style="margin-bottom:16px;">
      <div class="card" style="grid-column: span 4;">
        <h2>ì´ ë¦¬ë·° ìˆ˜</h2>
        <div class="stat" id="stat-count">â€”</div>
        <div class="kicker" id="stat-count-desc">DBì— ì ì¬ëœ ì „ì²´ ë¦¬ë·° ê°œìˆ˜</div>
      </div>
      <div class="card" style="grid-column: span 4;">
        <h2>í‰ê·  ê°ì„± ì ìˆ˜</h2>
        <div class="stat" id="stat-avg">â€”</div>
        <div class="kicker">ëª¨ë¸ ì‹ ë¢°ë„(0~1) í‰ê· , ì†Œìˆ˜ì  2ìë¦¬</div>
      </div>
      <div class="card" style="grid-column: span 4;">
        <h2>ê°ì„± ë¶„í¬</h2>
        <canvas id="pie" height="120"></canvas>
      </div>
    </div>

    <!-- ê²€ìƒ‰/í•„í„° ë°” -->
    <div class="card" style="margin-bottom:16px;">
      <div class="searchbar">
        <!-- í‚¤ì›Œë“œ ê²€ìƒ‰ -->
        <input id="q" class="input" type="search" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰ (ì˜ˆ: ë…¸ì´ì¦ˆ, ìƒ‰ê°, AF, ë°°í„°ë¦¬)">

        <!-- ê°ì„± í•„í„° -->
        <select id="sent" class="select">
          <option value="">ê°ì„±: ì „ì²´</option>
          <option value="positive">positive</option>
          <option value="neutral">neutral</option>
          <option value="negative">negative</option>
        </select>

        <!-- ì¹´ë©”ë¼ íšŒì‚¬ í•„í„° -->
        <select id="brand" class="select">
          <option value="ALL">ë¸Œëœë“œ: ì „ì²´</option>
        </select>

        <!-- íšŒì‚¬ì— ë”°ë¼ ë°”ë€ŒëŠ” ì¹´ë©”ë¼ ê¸°ì¢… í•„í„° -->
        <select id="camera" class="select">
          <option value="ALL">ì¹´ë©”ë¼: ì „ì²´</option>
        </select>

        <!-- í˜ì´ì§€ë‹¹ ê°œìˆ˜ -->
        <select id="size" class="select">
          <option value="10">10ê°œ</option>
          <option value="20" selected>20ê°œ</option>
          <option value="50">50ê°œ</option>
        </select>

        <button id="searchBtn" class="action">ê²€ìƒ‰</button>
        <a class="link" href="/swagger-ui.html">Swagger UI â†—</a>
      </div>
    </div>

    <!-- í‚¤ì›Œë“œ ì¸ì‚¬ì´íŠ¸ ì¹´ë“œ -->
    <div class="card" style="margin-bottom:16px;">
      <h2>í‚¤ì›Œë“œ ì¸ì‚¬ì´íŠ¸</h2>
      <div class="kicker" id="kw-title">
        ì„ íƒí•œ ì¹´ë©”ë¼/ê°ì„± ì¡°ê±´ì— ëŒ€í•œ ìƒìœ„ í‚¤ì›Œë“œì…ë‹ˆë‹¤.
      </div>
      <div id="keywords" class="kw-list">
        <span class="muted">í•„í„°ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ë©´ í‚¤ì›Œë“œê°€ ê°±ì‹ ë©ë‹ˆë‹¤.</span>
      </div>
    </div>

    <!-- ë¦¬ë·° í…Œì´ë¸” -->
    <div class="card" style="margin-bottom:16px;">
      <h2>ë¦¬ë·° ëª©ë¡</h2>
      <table id="tbl">
        <thead>
          <tr>
            <th>ê°ì„± ì ìˆ˜</th>
            <th>ê°ì„±</th>
            <th>ë‚´ìš©</th>
            <th class="col-date">ë“±ë¡ì¼</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="pager">
        <button id="prev" class="action">ì´ì „</button>
        <button id="next" class="action">ë‹¤ìŒ</button>
        <span id="pageInfo" class="small">0 / 0 Â· ì´ 0ê°œ</span>
      </div>
      <div class="muted" style="margin-top:8px;">
        * sentiment_label/scoreëŠ” Python ë¼ë²¨ëŸ¬(ëª¨ë¸)ì—ì„œ ê³„ì‚°ë©ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ í”Œë¡œíŒ… ì‚¬ì´ë“œ ë­í‚¹ ì¹´ë“œ -->
  <aside class="rank-float">
    <div class="card rank-card">
      <h2>ì¹´ë©”ë¼ ê°ì„± ì ìˆ˜ ë­í‚¹</h2>
      <div class="kicker small" id="rank-desc">
        ë¦¬ë·°ê°€ ì¶©ë¶„íˆ ìˆëŠ” ì¹´ë©”ë¼ë¥¼ í‰ê·  ê°ì„± ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬í–ˆìŠµë‹ˆë‹¤. (Top 10)
      </div>
      <div id="top-reco" class="kicker small" style="margin:6px 0 10px;">
        <!-- TOP 1 ì¶”ì²œ ë¬¸êµ¬ -->
      </div>
      <table id="rank-tbl">
        <thead>
        <tr>
          <th style="width:34px;">#</th>
          <th>ì¹´ë©”ë¼</th>
          <th style="width:80px;">í‰ê·  ì ìˆ˜</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted" style="margin-top:6px;">
        í–‰ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì¹´ë©”ë¼ë¡œ í•„í„°ë§ë©ë‹ˆë‹¤.
      </div>
    </div>
  </aside>

  <script>
    const API = window.location.origin;
    let chart;

    // ê²€ìƒ‰ ìƒíƒœ
    let S = { page: 0, size: 20, sentiment: '', query: '', camera: 'ALL', brand: 'ALL' };

    // ì¹´ë©”ë¼ ë¸Œëœë“œ/ëª¨ë¸ ë§µ
    let CAMERA_BRAND_MAP = {};   // { Canon: [Canon EOS R8, ...], Sony: [...] }
    let ALL_CAMERAS = [];

    const j = async (path) => {
      const url = path.startsWith('http') ? path : `${API}${path}`;
      const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const body = await r.text();
      if (!r.ok) {
        console.error(`[HTTP ${r.status}] ${url}\n${body}`);
        throw new Error(`HTTP ${r.status} ${url}`);
      }
      try { return JSON.parse(body); }
      catch(e) {
        console.error(`JSON parse error on ${url}`, e, '\nRaw:', body);
        throw e;
      }
    };

    const badge = (label) => {
      if (!label) return '';
      const cls = label === 'positive' ? 'pos' : label === 'negative' ? 'neg' : 'neu';
      return `<span class="badge ${cls}">${label}</span>`;
    };

    function formatDate(iso) {
      if (!iso) return '';
      const s = iso.toString();
      if (s.includes('T')) return s.split('T')[0];
      return s.slice(0, 10);
    }

    function populateCameraByBrand(brand) {
      const camEl = document.getElementById('camera');
      if (!camEl) return;

      camEl.innerHTML = '<option value="ALL">ì¹´ë©”ë¼: ì „ì²´</option>';

      let models;
      if (!brand || brand === 'ALL') {
        models = ALL_CAMERAS;
      } else {
        models = CAMERA_BRAND_MAP[brand] || [];
      }

      models.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        camEl.appendChild(opt);
      });
    }

    async function loadCameraOptions() {
      const brandEl = document.getElementById('brand');
      const camEl   = document.getElementById('camera');
      if (!brandEl || !camEl) return;

      brandEl.innerHTML = '<option value="ALL">ë¸Œëœë“œ: ì „ì²´</option>';
      camEl.innerHTML   = '<option value="ALL">ì¹´ë©”ë¼: ì „ì²´</option>';

      try {
        const list = await j('/api/cameras');
        if (!Array.isArray(list) || list.length === 0) {
          return;
        }

        ALL_CAMERAS = [...list];

        CAMERA_BRAND_MAP = {};
        list.forEach(name => {
          const brand = (name || '').trim().split(' ')[0] || 'ê¸°íƒ€';
          if (!CAMERA_BRAND_MAP[brand]) CAMERA_BRAND_MAP[brand] = [];
          CAMERA_BRAND_MAP[brand].push(name);
        });

        const brands = Object.keys(CAMERA_BRAND_MAP).sort();
        brands.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b;
          opt.textContent = b;
          brandEl.appendChild(opt);
        });

        populateCameraByBrand('ALL');
      } catch (e) {
        console.error('ì¹´ë©”ë¼/ë¸Œëœë“œ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨', e);
      }
    }

    async function loadSummary() {
      const params = new URLSearchParams();
      if (S.camera && S.camera !== 'ALL') params.set('camera', S.camera);
      const qs = params.toString() ? `?${params.toString()}` : '';
      const data = await j(`/api/stats/summary${qs}`);

      const count = Number(data.count ?? 0);
      const avg   = Number(data.avgSentiment ?? 0);

      const $count = document.getElementById('stat-count');
      const $avg   = document.getElementById('stat-avg');
      const $desc  = document.getElementById('stat-count-desc');

      $count.textContent = String(count);
      $avg.textContent   = avg.toFixed(2);

      if (S.camera && S.camera !== 'ALL') {
        $desc.textContent = `ì„ íƒëœ ì¹´ë©”ë¼(${S.camera})ì— ëŒ€í•œ ë¦¬ë·° ê°œìˆ˜`;
      } else {
        $desc.textContent = 'DBì— ì ì¬ëœ ì „ì²´ ë¦¬ë·° ê°œìˆ˜';
      }
    }

    async function loadSentimentChart() {
      const params = new URLSearchParams();
      if (S.camera && S.camera !== 'ALL') params.set('camera', S.camera);
      const qs = params.toString() ? `?${params.toString()}` : '';
      const d = await j(`/api/stats/sentiment${qs}`);

      const b = d.buckets || {};
      const pos = Number(b.positive || 0);
      const neu = Number(b.neutral || 0);
      const neg = Number(b.negative || 0);

      const ctx = document.getElementById('pie');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['positive', 'neutral', 'negative'],
          datasets: [{ data: [pos, neu, neg] }]
        },
        options: {
          plugins: {
            legend: { labels: { color: '#e2e8f0' } }
          }
        }
      });
    }

    // ğŸ” í•­ìƒ /api/reviews/searchë§Œ ì‚¬ìš©
    async function loadReviews() {
      const params = new URLSearchParams();
      if (S.sentiment) params.set('sentiment', S.sentiment);
      if (S.query)     params.set('query', S.query);
      if (S.camera && S.camera !== 'ALL') params.set('camera', S.camera);
      params.set('page', S.page);
      params.set('size', S.size);

      const resp = await j(`/api/reviews/search?${params.toString()}`);
      const rows = Array.isArray(resp) ? resp : (resp.content || []);
      updateTable(rows);

      const pageInfo      = resp.page ?? resp.number ?? S.page;
      const totalPages    = resp.totalPages ?? 1;
      const totalElements = resp.totalElements ?? rows.length;
      updatePager(pageInfo, totalPages, totalElements);
    }

    async function loadKeywords() {
      const params = new URLSearchParams();
      if (S.camera && S.camera !== 'ALL') params.set('camera', S.camera);
      if (S.sentiment) params.set('sentiment', S.sentiment);
      params.set('limit', '20');

      let title = 'ì „ì²´ ì¹´ë©”ë¼ / ì „ì²´ ê°ì„± ê¸°ì¤€ ìƒìœ„ í‚¤ì›Œë“œ';
      if (S.camera && S.camera !== 'ALL') {
        title = `${S.camera} / `;
        title += S.sentiment ? S.sentiment : 'ì „ì²´ ê°ì„±';
        title += ' ê¸°ì¤€ ìƒìœ„ í‚¤ì›Œë“œ';
      } else if (S.sentiment) {
        title = `ì „ì²´ ì¹´ë©”ë¼ / ${S.sentiment} ê¸°ì¤€ ìƒìœ„ í‚¤ì›Œë“œ`;
      }
      document.getElementById('kw-title').textContent = title;

      try {
        const list = await j(`/api/stats/keywords?${params.toString()}`);
        const box = document.getElementById('keywords');

        if (!Array.isArray(list) || list.length === 0) {
          box.innerHTML = '<span class="muted">í•´ë‹¹ ì¡°ê±´ì— ëŒ€í•œ í‚¤ì›Œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
          return;
        }

        box.innerHTML = list.map(k => `
          <span class="kw-chip">
            <span>${k.keyword}</span>
            <span class="kw-freq">Ã— ${k.freq}</span>
          </span>
        `).join('');
      } catch (e) {
        console.error('í‚¤ì›Œë“œ ë¡œë”© ì‹¤íŒ¨', e);
        const box = document.getElementById('keywords');
        box.innerHTML = '<span class="muted">í‚¤ì›Œë“œ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>';
      }
    }

    function updateTable(rows) {
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${(r.sentimentScore ?? '').toString()}</td>
          <td>${badge(r.sentimentLabel)}</td>
          <td>${(r.content || '').replace(/</g,'&lt;')}</td>
          <td class="col-date">${formatDate(r.createdAt)}</td>
        </tr>
      `).join('');
    }

    function updatePager(page, totalPages, totalElements) {
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const info    = document.getElementById('pageInfo');

      prevBtn.disabled = (page <= 0);
      nextBtn.disabled = (page >= totalPages - 1);

      info.textContent = `${(page || 0) + 1} / ${totalPages || 1} Â· ì´ ${totalElements || 0}ê°œ`;
    }

    async function loadRanking() {
      const MIN_COUNT = 30;
      const data = await j(`/api/stats/ranking?minCount=${MIN_COUNT}`);

      const tbody = document.querySelector('#rank-tbl tbody');
      const topEl = document.getElementById('top-reco');

      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="3" class="small">ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¹´ë©”ë¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>`;
        if (topEl) {
          topEl.textContent = 'ì¶©ë¶„í•œ ë¦¬ë·°ê°€ ìˆëŠ” ì¹´ë©”ë¼ê°€ ì—†ì–´ì„œ ì¶”ì²œì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        }
        return;
      }

      const top10 = data.slice(0, 10);

      tbody.innerHTML = top10.map((row, idx) => {
        const cam = row.camera || '';
        const avg = Number(row.avgSentiment ?? 0).toFixed(2);
        return `
          <tr data-camera="${cam}">
            <td>${idx + 1}</td>
            <td>${cam}</td>
            <td>${avg}</td>
          </tr>
        `;
      }).join('');

      const first = top10[0];
      const camName = first.camera || '';
      const avg = Number(first.avgSentiment ?? 0).toFixed(2);
      const cnt = first.count ?? 0;

      if (topEl && camName) {
        topEl.innerHTML =
          `í˜„ì¬ ìˆ˜ì§‘ëœ ë¦¬ë·° ê¸°ì¤€, ê°€ì¥ ê¸ì •ì ì¸ ì¹´ë©”ë¼ëŠ” <strong>${camName}</strong> ì…ë‹ˆë‹¤. `
          + `(í‰ê·  ê°ì„± ì ìˆ˜ ${avg}, ë¦¬ë·° ${cnt}ê°œ ê¸°ì¤€)`;
      }

      tbody.querySelectorAll('tr[data-camera]').forEach(tr => {
        tr.addEventListener('click', async () => {
          const cam = tr.getAttribute('data-camera');
          const brand = (cam || '').trim().split(' ')[0] || 'ALL';

          const brandEl = document.getElementById('brand');
          const camEl   = document.getElementById('camera');

          if (brandEl && CAMERA_BRAND_MAP[brand]) {
            brandEl.value = brand;
          } else if (brandEl) {
            brandEl.value = 'ALL';
          }

          populateCameraByBrand(brandEl ? brandEl.value : 'ALL');
          if (camEl) {
            camEl.value = cam;
          }

          S.brand  = brandEl ? brandEl.value : 'ALL';
          S.camera = cam;
          S.page   = 0;

          await loadSummary();
          await loadSentimentChart();
          await loadReviews();
          await loadKeywords();

          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    }

    function setupUI() {
      const qEl    = document.getElementById('q');
      const sentEl = document.getElementById('sent');
      const sizeEl = document.getElementById('size');
      const brandEl= document.getElementById('brand');
      const camEl  = document.getElementById('camera');
      const searchBtn = document.getElementById('searchBtn');

      searchBtn?.addEventListener('click', async () => {
        S.query     = qEl?.value.trim() || '';
        S.sentiment = sentEl?.value || '';
        S.size      = Number(sizeEl?.value || 20);
        S.brand     = brandEl?.value || 'ALL';
        S.camera    = camEl?.value || 'ALL';
        S.page = 0;
        await loadSummary();
        await loadSentimentChart();
        await loadReviews();
        await loadKeywords();
      });

      sentEl?.addEventListener('change', async () => {
        S.sentiment = sentEl.value;
        S.page = 0;
        await loadSummary();
        await loadSentimentChart();
        await loadReviews();
        await loadKeywords();
      });

      // âœ… ë¸Œëœë“œ ë³€ê²½ ì‹œ: í†µê³„/ë„ë„›ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , ë¦¬ë·° + í‚¤ì›Œë“œë§Œ ìƒˆë¡œê³ ì¹¨
      brandEl?.addEventListener('change', async () => {
        S.brand = brandEl.value || 'ALL';
        populateCameraByBrand(S.brand);
        const camElInner = document.getElementById('camera');
        if (camElInner) camElInner.value = 'ALL';
        S.camera = 'ALL';
        S.page = 0;
        await loadReviews();
        await loadKeywords();
      });

      camEl?.addEventListener('change', async () => {
        S.camera = camEl.value || 'ALL';
        S.page = 0;
        await loadSummary();
        await loadSentimentChart();
        await loadReviews();
        await loadKeywords();
      });

      document.getElementById('prev')?.addEventListener('click', async () => {
        if (S.page > 0) {
          S.page -= 1;
          await loadReviews();
          await loadKeywords();
        }
      });

      document.getElementById('next')?.addEventListener('click', async () => {
        S.page += 1;
        await loadReviews();
        await loadKeywords();
      });
    }

    (async function init() {
      setupUI();
      await loadCameraOptions();

      try { await loadSummary(); }        catch(e){ console.error(e); alert('ìš”ì•½ í†µê³„ ë¡œë”© ì‹¤íŒ¨'); return; }
      try { await loadSentimentChart(); } catch(e){ console.error(e); alert('ê°ì„± ë¶„í¬ ë¡œë”© ì‹¤íŒ¨'); return; }
      try { await loadReviews(); }        catch(e){ console.error(e); alert('ë¦¬ë·° ë¡œë”© ì‹¤íŒ¨'); return; }
      try { await loadKeywords(); }       catch(e){ console.error(e); }
      try { await loadRanking(); }        catch(e){ console.error(e); }
    })();
  </script>
</body>
</html>