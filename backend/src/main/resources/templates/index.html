<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Camera Review Analyzer</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/modern-css-reset@1.4.0/dist/reset.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Apple SD Gothic Neo, "Noto Sans KR", Arial, sans-serif; background:#0f172a; color:#e2e8f0; }
    .wrap { max-width: 1100px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 26px; font-weight: 700; margin-bottom: 18px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }
    .card { background:#111827; border:1px solid #1f2937; border-radius: 16px; padding: 18px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    .card h2 { font-size:14px; color:#94a3b8; margin-bottom:8px; font-weight:600; }
    .stat { font-size: 28px; font-weight:800; color:#f1f5f9; }
    .muted { color:#94a3b8; font-size:12px; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #1f2937; vertical-align: top; }
    th { text-align:left; color:#93c5fd; font-weight:700; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #1f2937; }
    .pos { color:#22c55e; border-color:#14532d; background:#052e16; }
    .neu { color:#eab308; border-color:#713f12; background:#422006; }
    .neg { color:#f43f5e; border-color:#7f1d1d; background:#450a0a; }
    a.link { color:#93c5fd; text-decoration:none; }
    .kicker { color:#94a3b8; font-size:12px; margin-top:6px; }

    .searchbar { display:flex; gap:8px; flex-wrap:wrap; }
    .input, .select { background:#0b1220; color:#e2e8f0; border:1px solid #334155; border-radius:10px; padding:8px 12px; font-size:14px; }
    .input { flex:1 1 280px; }
    .select { min-width:140px; }
    .action { background:#1f2937; border:1px solid #334155; color:#cbd5e1; padding:8px 14px; border-radius:10px; cursor:pointer; }
    .pager { display:flex; align-items:center; gap:10px; margin-top:12px; }
    .pager .action[disabled] { opacity:.5; cursor:not-allowed; }
    .small { font-size:12px; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Camera Review Analyzer</h1>

    <!-- 상단 카드: 통계 -->
    <div class="grid" style="margin-bottom:16px;">
      <div class="card" style="grid-column: span 4;">
        <h2>총 리뷰 수</h2>
        <div class="stat" id="stat-count">—</div>
        <div class="kicker">DB에 적재된 전체 리뷰 개수</div>
      </div>
      <div class="card" style="grid-column: span 4;">
        <h2>평균 감성 점수</h2>
        <div class="stat" id="stat-avg">—</div>
        <div class="kicker">모델 신뢰도(0~1) 평균, 소수점 2자리</div>
      </div>
      <div class="card" style="grid-column: span 4;">
        <h2>감성 분포</h2>
        <canvas id="pie" height="120"></canvas>
      </div>
    </div>

    <!-- 검색/필터 바 -->
    <div class="card" style="margin-bottom:16px;">
      <div class="searchbar">
        <input id="q" class="input" type="search" placeholder="키워드 검색 (예: 노이즈, 색감, AF, 배터리)">

        <select id="sent" class="select">
          <option value="">감성: 전체</option>
          <option value="positive">positive</option>
          <option value="neutral">neutral</option>
          <option value="negative">negative</option>
        </select>

        <!-- ✅ 새로 추가: 카메라 기종 필터 -->
        <select id="camera" class="select">
          <option value="">카메라: 전체</option>
          <!-- 옵션들은 JS에서 동적으로 채움 -->
        </select>

        <select id="size" class="select">
          <option value="10">10개</option>
          <option value="20" selected>20개</option>
          <option value="50">50개</option>
        </select>

        <button id="searchBtn" class="action">검색</button>
        <a class="link" href="/swagger-ui.html" style="margin-left:auto;">Swagger UI ↗</a>
      </div>

    <!-- 리뷰 테이블 -->
    <div class="card">
      <h2>리뷰 목록</h2>
      <table id="tbl">
        <thead>
          <!-- ID 제거, 평점 → 감성 점수 -->
          <tr><th>감성 점수</th><th>감성</th><th>내용</th><th>등록일</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="pager">
        <button id="prev" class="action">이전</button>
        <button id="next" class="action">다음</button>
        <span id="pageInfo" class="small">0 / 0</span>
      </div>
      <div class="muted" style="margin-top:8px;">* sentiment_label은 Python 라벨러 또는 모델에서 계산됩니다.</div>
    </div>
  </div>

  <script>
    const API = window.location.origin;

    let chart;
    let ALL_ROWS = [];      // DB에서 온 전체 리뷰
    let FILTERED_ROWS = []; // 필터/검색 적용된 결과

    const j = async (path) => {
      const url = path.startsWith('http') ? path : `${API}${path}`;
      const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const body = await r.text();
      if (!r.ok) {
        console.error(`[HTTP ${r.status}] ${url}\n${body}`);
        throw new Error(`HTTP ${r.status} ${url}`);
      }
      try { return JSON.parse(body); }
      catch (e) { console.error(`JSON parse error on ${url}`, e, '\nRaw:', body); throw e; }
    };

    const badge = (label) => {
      if (!label) return '';
      const cls = label === 'positive' ? 'pos' : label === 'negative' ? 'neg' : 'neu';
      return `<span class="badge ${cls}">${label}</span>`;
    };

    async function loadSummary() {
      const data = await j('/api/stats/summary');
      const count = Number(data.count ?? 0);
      const avg   = Number(data.avgSentiment ?? 0);  // ← 여기만 변경

      document.getElementById('stat-count').textContent = String(count);
      document.getElementById('stat-avg').textContent   = avg.toFixed(2);
    }

    async function loadSentimentChart() {
      const d = await j('/api/stats/sentiment');
      const b = d.buckets || {};
      const pos = Number(b.positive || 0), neu = Number(b.neutral || 0), neg = Number(b.negative || 0);
      const ctx = document.getElementById('pie');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['positive', 'neutral', 'negative'], datasets: [{ data: [pos, neu, neg] }] },
        options: { plugins: { legend: { labels: { color: '#e2e8f0' } } } }
      });
    }

    // 검색 상태
    let S = {
      page: 0,
      size: 20,
      sentiment: '',
      camera: '',  
      query: ''
    };

    // 전체 리뷰를 서버에서 가져옴
    async function loadAllReviews() {
      const arr = await j('/api/reviews/all');
      ALL_ROWS = Array.isArray(arr) ? arr : [];

      buildCameraOptions();
      applyFilterAndPagination();
    }
    function buildCameraOptions() {
      const select = document.getElementById('camera');
      if (!select) return;

      // cameraModel 값들만 모아서 정렬 + 중복 제거
      const set = new Set();
      ALL_ROWS.forEach(r => {
        const m = (r.cameraModel || r.camera_model || '').trim();
        if (m) set.add(m);
      });

      // 기존 옵션(전체)만 남기고 나머지 제거
      select.innerHTML = '<option value="">카메라: 전체</option>';

      Array.from(set).sort().forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        select.appendChild(opt);
      });
    }

    function applyFilterAndPagination() {
      const q = (S.query || '').toLowerCase();

      FILTERED_ROWS = ALL_ROWS.filter(r => {
        const matchSent =
          !S.sentiment ||
          (r.sentimentLabel && r.sentimentLabel.toLowerCase() === S.sentiment.toLowerCase());

        const text = (r.content || '').toLowerCase();
        const matchQuery = !q || text.includes(q);

        // 카메라 매칭 (없으면 전체)
        const cam = (S.camera || '').toLowerCase();
        const model = (r.cameraModel || r.camera_model || '').toLowerCase();
        const matchCamera = !cam || model === cam;

        return matchSent && matchQuery && matchCamera;
      });

      const total = FILTERED_ROWS.length;
      const size  = S.size;
      const totalPages = Math.max(1, Math.ceil(total / size));

      if (S.page >= totalPages) S.page = totalPages - 1;
      if (S.page < 0) S.page = 0;

      const start = S.page * size;
      const pageRows = FILTERED_ROWS.slice(start, start + size);

      updateTable(pageRows);
      updatePager(S.page, totalPages, total);
    }

    function updateTable(rows) {
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${r.sentimentScore != null ? Number(r.sentimentScore).toFixed(3) : ''}</td>
          <td>${badge(r.sentimentLabel)}</td>
          <td>${(r.content || '').replace(/</g,'&lt;')}</td>
          <td>${r.createdAt ?? ''}</td>
        </tr>
      `).join('');
    }

    function updatePager(page, totalPages, totalElements) {
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const info    = document.getElementById('pageInfo');
      prevBtn.disabled = (page <= 0);
      nextBtn.disabled = (page >= totalPages - 1);
      info.textContent = `${page + 1} / ${totalPages} · 총 ${totalElements || 0}개`;
    }

    function setupUI() {
      document.getElementById('searchBtn')?.addEventListener('click', async () => {
        S.query = document.getElementById('q').value.trim();
        S.sentiment = document.getElementById('sent').value;
        S.camera    = document.getElementById('camera').value;
        S.size = Number(document.getElementById('size').value || 20);
        S.page = 0;
        applyFilterAndPagination(); // ALL_ROWS는 그대로 두고 필터/페이지 재계산
      });

      document.getElementById('prev')?.addEventListener('click', () => {
        if (S.page > 0) {
          S.page -= 1;
          applyFilterAndPagination();
        }
      });

      document.getElementById('next')?.addEventListener('click', () => {
        S.page += 1;
        applyFilterAndPagination();
      });

      document.getElementById('size')?.addEventListener('change', () => {
        S.size = Number(document.getElementById('size').value || 20);
        S.page = 0;
        applyFilterAndPagination();
      });
    }

    (async function init() {
      setupUI();
      try { await loadSummary(); }        catch(e){ console.error(e); alert('요약 통계 로딩 실패'); return; }
      try { await loadSentimentChart(); } catch(e){ console.error(e); alert('감성 분포 로딩 실패'); return; }
      try { await loadAllReviews(); }     catch(e){ console.error(e); alert('리뷰 로딩 실패'); return; }
    })();
  </script>
</body>
</html>